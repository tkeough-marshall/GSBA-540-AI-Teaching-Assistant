<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Manage Course Files</title>
<style>
:root {
  --cardinal:#990000; --gold:#ffd700;
  --ink:#222; --muted:#777;
  --bg:#f8f8f8; --panel:#fff; --line:#e7e7e7;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--ink);}
header{background:var(--cardinal);color:#fff;padding:16px 24px;display:flex;justify-content:space-between;align-items:center}
header a{color:var(--gold);text-decoration:none}
.frame{max-width:1100px;margin:28px auto;background:var(--panel);border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,.08);padding:22px;min-height:720px;display:flex;flex-direction:column;position:relative}
h2{margin:0 0 8px;color:var(--cardinal)}
.rule{height:2px;background:var(--gold);width:100%;margin:6px 0 18px;border-radius:2px}
.drop{border:2px dashed #cfcfcf;border-radius:10px;padding:22px;text-align:center;background:#fafafa;margin-bottom:12px;transition:background .2s,border-color .2s}
.drop.drag{border-color:var(--cardinal);background:#fff6f6}
.btn{background:var(--cardinal);color:#fff;border:0;border-radius:8px;padding:9px 14px;font-size:.92rem;cursor:pointer}
.btn.secondary{background:#f3f3f3;color:#333}
.btn.danger{background:#b11226}
.btn:disabled{opacity:.5;cursor:not-allowed}
.bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:12px 0}
.bar input[type="text"]{flex:1;border:1px solid #d5d5d5;border-radius:8px;padding:9px 12px}
.crumb{font-size:.9rem;color:#444;margin-bottom:8px}
.crumb a{color:var(--cardinal);text-decoration:none;cursor:pointer}
.crumb .sep{color:#bbb;margin:0 6px}
.progress{display:none;align-items:center;gap:10px;margin:8px 0}
.progress .track{flex:1;height:10px;background:#eee;border-radius:8px;overflow:hidden}
.progress .fill{height:100%;width:0;background:var(--cardinal);transition:width .15s linear}
table{width:100%;border-collapse:collapse;border-radius:10px;overflow:hidden}
thead{background:#f6f6f6}
th,td{padding:11px 12px;border-bottom:1px solid var(--line);font-size:.92rem}
tbody tr:hover{background:#fff6f6}
.muted{color:var(--muted)}
.icon.folder{width:14px;height:14px;border:2px solid var(--cardinal);border-radius:3px;margin-right:8px;display:inline-block;position:relative;vertical-align:-3px}
.icon.folder:before{content:"";position:absolute;top:-5px;left:2px;width:8px;height:5px;background:var(--cardinal);border-radius:2px 2px 0 0}
.row-actions{display:flex;gap:8px;justify-content:flex-end}

/* clean floating modal (no grey background) */
.modal{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border-radius:12px;width:340px;padding:18px 20px;box-shadow:0 6px 18px rgba(0,0,0,.25);z-index:30}
.modal h3{margin-top:0;font-size:1rem;color:var(--cardinal)}
.modal input, .modal select{width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;margin:10px 0}
.modal .actions{display:flex;justify-content:flex-end;gap:10px;margin-top:8px}
</style>
</head>
<body>
<header>
  <span>Course File Manager</span>
  <a href="/">← Back</a>
</header>

<div class="frame">
  <h2>Manage Uploaded Materials</h2>
  <div class="rule"></div>

  <div id="drop" class="drop" ondrop="onDrop(event)" ondragover="onDrag(event)" ondragleave="onLeave(event)">
    <div class="muted" style="margin-bottom:6px">Drag and drop files here</div>
    <div class="muted" style="margin-bottom:10px">or</div>
    <input id="fileInput" type="file" multiple hidden />
    <button class="btn" onclick="document.getElementById('fileInput').click()">Select Files</button>
  </div>

  <div class="bar">
    <input id="search" type="text" placeholder="Search files..." oninput="render()"/>
    <button class="btn secondary" onclick="openNewFolderModal()">New Folder</button>
    <button id="moveBtn" class="btn secondary" onclick="openMoveModal()" disabled>Move</button>
    <button id="deleteBtn" class="btn danger" onclick="openDeleteModal()" disabled>Delete Selected</button>
  </div>

  <div class="crumb" id="crumb"></div>

  <div class="progress" id="progress">
    <span id="ptext" class="muted">Uploading…</span>
    <div class="track"><div class="fill" id="pfill"></div></div>
    <span id="pnum" class="muted">0%</span>
  </div>

  <table>
    <thead>
      <tr>
        <th style="width:36px"><input type="checkbox" id="selectAll"/></th>
        <th>Name</th>
        <th style="width:120px">Type</th>
        <th style="width:220px">Date Added</th>
        <th style="width:150px;text-align:right"></th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<script>
let files = [];
let folders = ["All Files"];
let fileFolder = {};
let currentPath = [];

function pathToString(p){return p.length?p.join("/"):"All Files";}

function showProgress(name,pct){
  const bar=document.getElementById("progress");
  bar.style.display="flex";
  document.getElementById("ptext").textContent=`Uploading ${name}`;
  document.getElementById("pfill").style.width=`${pct}%`;
  document.getElementById("pnum").textContent=`${Math.round(pct)}%`;
  if(pct>=100)setTimeout(()=>bar.style.display="none",600);
}

async function loadFiles(){
  const res=await fetch("/api/files");
  files=await res.json();
  render();
}

function render(){
  const tbody=document.getElementById("tbody");
  tbody.innerHTML="";
  const here=pathToString(currentPath);
  const q=(document.getElementById("search").value||"").toLowerCase();
  const selected=document.querySelectorAll(".rowcheck:checked");
  document.getElementById("deleteBtn").disabled=selected.length===0;
  document.getElementById("moveBtn").disabled=selected.length===0;

  const crumb=document.getElementById("crumb");
  crumb.innerHTML="";
  const root=document.createElement("a");
  root.textContent="All Files";
  root.onclick=()=>{currentPath=[];render();};
  crumb.appendChild(root);

  currentPath.forEach((seg,i)=>{
    const sep=document.createElement("span");
    sep.className="sep";sep.textContent="›";
    crumb.appendChild(sep);
    const a=document.createElement("a");
    a.textContent=seg;
    a.onclick=()=>{currentPath=currentPath.slice(0,i+1);render();};
    crumb.appendChild(a);
  });

  const fileRows=files.filter(f=>{
    const assigned=fileFolder[f.file_name]||"All Files";
    return assigned===here && f.file_name.toLowerCase().includes(q);
  });

  if(fileRows.length===0){
    const tr=document.createElement("tr");
    tr.innerHTML=`<td></td><td class="muted" colspan="4">No files found.</td>`;
    tbody.appendChild(tr);
  } else {
    for(const f of fileRows){
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td><input type="checkbox" class="rowcheck" data-name="${f.file_name}"/></td>
        <td>${f.file_name}</td>
        <td>${f.file_type||"—"}</td>
        <td>${f.uploaded_at?new Date(f.uploaded_at).toLocaleString():"—"}</td>
        <td class="row-actions">
          <button class="btn secondary" onclick="openMoveModal('${f.file_name}')">Move</button>
          <button class="btn danger" onclick="openDeleteModal('${f.file_name}')">Delete</button>
        </td>`;
      tbody.appendChild(tr);
    }
  }
  document.getElementById("selectAll").checked=false;
}

document.addEventListener("change",e=>{
  if(e.target.classList.contains("rowcheck"))render();
});
document.getElementById("selectAll").addEventListener("change",e=>{
  document.querySelectorAll(".rowcheck").forEach(c=>c.checked=e.target.checked);
  render();
});

function onDrag(e){e.preventDefault();document.getElementById("drop").classList.add("drag");}
function onLeave(e){e.preventDefault();document.getElementById("drop").classList.remove("drag");}
function onDrop(e){
  e.preventDefault();onLeave(e);
  [...e.dataTransfer.files].forEach(f=>uploadFile(f));
}
document.getElementById("fileInput").addEventListener("change",e=>{
  [...e.target.files].forEach(f=>uploadFile(f));
  e.target.value="";
});

function uploadFile(file){
  const xhr=new XMLHttpRequest();
  xhr.open("POST","/upload");
  xhr.upload.onprogress=e=>{
    if(e.lengthComputable)showProgress(file.name,(e.loaded/e.total)*100);
  };
  xhr.onload=()=>{
    if(xhr.status===200){
      const uploaded=JSON.parse(xhr.responseText);
      files.push(uploaded); // immediate visual insert
      const dest=pathToString(currentPath);
      if(dest!=="All Files")fileFolder[uploaded.file_name]=dest;
      render();
    }
  };
  const form=new FormData();
  form.append("file",file);
  xhr.send(form);
}

/* simple floating modal (no overlay) */
function showModal(title,contentHTML,onConfirm){
  const modal=document.createElement("div");
  modal.className="modal";
  modal.innerHTML=`
    <h3>${title}</h3>
    <div>${contentHTML}</div>
    <div class="actions">
      <button class="btn secondary">Cancel</button>
      <button class="btn">OK</button>
    </div>`;
  document.querySelector(".frame").appendChild(modal);
  modal.querySelector(".btn.secondary").onclick=()=>modal.remove();
  modal.querySelector(".btn").onclick=()=>{onConfirm(modal);modal.remove();};
}

function openNewFolderModal(){
  showModal("New Folder","<input id='folderName' placeholder='Folder name'/>",m=>{
    const val=m.querySelector("#folderName").value.trim();
    if(!val)return;
    const full=pathToString(currentPath)==="All Files"?val:`${pathToString(currentPath)}/${val}`;
    if(!folders.includes(full))folders.push(full);
    render();
  });
}
function openMoveModal(singleName=null){
  const selected=singleName?[singleName]:[...document.querySelectorAll(".rowcheck:checked")].map(e=>e.dataset.name);
  if(selected.length===0)return;
  const opts=folders.map(f=>`<option>${f}</option>`).join("");
  showModal("Move Files",`<select id='destSelect'>${opts}</select>`,m=>{
    const dest=m.querySelector("#destSelect").value;
    selected.forEach(n=>fileFolder[n]=dest);
    render();
  });
}
function openDeleteModal(singleName=null){
  const selected=singleName?[singleName]:[...document.querySelectorAll(".rowcheck:checked")].map(e=>e.dataset.name);
  if(selected.length===0)return;
  showModal("Delete Files",`<p>Delete ${selected.length} file(s)?</p>`,async()=>{
    await Promise.all(selected.map(n=>fetch("/delete/"+n,{method:"DELETE"})));
    files=files.filter(f=>!selected.includes(f.file_name));
    render();
  });
}

loadFiles();
</script>
</body>
</html>
