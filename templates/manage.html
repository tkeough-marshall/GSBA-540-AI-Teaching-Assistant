<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manage Course Files</title>
  <style>
    body {
      font-family: "Inter", system-ui, sans-serif;
      background-color: #f8f8f8;
      margin: 0;
      padding: 0;
      color: #222;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      background-color: #990000;
      color: white;
      padding: 16px 24px;
      font-size: 1.2em;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header a {
      color: #ffd700;
      text-decoration: none;
      font-weight: 500;
    }

    main {
      display: flex;
      flex: 1;
      max-width: 1200px;
      margin: 32px auto;
      gap: 20px;
    }

    /* Sidebar */
    .sidebar {
      width: 220px;
      background: #fff;
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      height: fit-content;
    }

    .sidebar h3 {
      font-size: 1em;
      color: #990000;
      border-bottom: 2px solid #ffd700;
      margin-bottom: 10px;
      padding-bottom: 4px;
    }

    .folder {
      padding: 8px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      margin-bottom: 4px;
      transition: background 0.2s ease;
    }

    .folder.active {
      background-color: #fff6f6;
      font-weight: 600;
      color: #990000;
    }

    .folder:hover {
      background-color: #f5f5f5;
    }

    .folder-actions {
      margin-top: 10px;
    }

    .folder-actions button {
      background: #990000;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 0.8em;
      cursor: pointer;
    }

    /* Main content */
    .content {
      flex: 1;
      background: #fff;
      border-radius: 10px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    h2 {
      color: #990000;
      border-bottom: 2px solid #ffd700;
      padding-bottom: 8px;
      margin-bottom: 16px;
    }

    .upload-box {
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      margin-bottom: 12px;
      background-color: #fafafa;
      transition: border 0.2s ease, background-color 0.2s ease;
    }

    .upload-box.dragover {
      border-color: #990000;
      background-color: #fff6f6;
    }

    .btn {
      background-color: #990000;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background 0.2s ease;
    }
    .btn:hover { background-color: #b11226; }

    #progressContainer { margin-top: 10px; margin-bottom: 20px; }
    progress { width: 100%; height: 10px; appearance: none; }
    progress::-webkit-progress-bar { background-color: #eee; border-radius: 10px; }
    progress::-webkit-progress-value { background-color: #b11226; border-radius: 10px; }

    /* Toolbar */
    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .toolbar input[type="text"] {
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 0.9em;
      flex: 1;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 8px;
      overflow: hidden;
    }

    thead { background-color: #f3f3f3; }
    th, td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
      font-size: 0.9em;
    }

    tbody tr:hover { background-color: #fff6f6; }

    .delete-btn {
      background-color: #fff0f0;
      color: #990000;
      border: 1px solid #f1d2d2;
      border-radius: 6px;
      padding: 4px 10px;
      cursor: pointer;
      font-size: 0.8em;
    }
    .delete-btn:hover { background-color: #ffecec; }

    footer {
      text-align: center;
      color: #777;
      padding: 16px;
      font-size: 0.9em;
      border-top: 1px solid #eee;
    }
  </style>
</head>

<body>
  <header>
    <span>Course File Manager</span>
    <a href="/">← Back to Assistant</a>
  </header>

  <main>
    <!-- Sidebar -->
    <aside class="sidebar">
      <h3>Folders</h3>
      <div id="folderList"></div>
      <div class="folder-actions">
        <button onclick="createFolder()">+ New Folder</button>
      </div>
    </aside>

    <!-- Main content -->
    <section class="content">
      <h2>Manage Uploaded Materials</h2>

      <div id="dropZone" class="upload-box"
        ondrop="handleDrop(event)" ondragover="handleDrag(event)" ondragleave="handleLeave(event)">
        <p>Drag and drop files here</p>
        <p>or</p>
        <input type="file" id="fileInput" style="display:none" multiple />
        <button class="btn" onclick="document.getElementById('fileInput').click()">Select Files</button>
      </div>

      <div id="progressContainer">
        <progress id="uploadProgress" value="0" max="100" style="display:none;"></progress>
      </div>

      <div class="toolbar">
        <input type="text" id="searchInput" placeholder="Search files..." oninput="filterFiles()" />
        <button class="btn" onclick="deleteSelected()">Delete Selected</button>
      </div>

      <table id="fileTable">
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)" /></th>
            <th>File Name</th>
            <th>Type</th>
            <th>Date Added</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="fileTableBody"></tbody>
      </table>
    </section>
  </main>

  <footer>
    Managed securely via Supabase · USC Marshall AI Strategy Initiative
  </footer>

  <script>
    let filesCache = [];
    let currentFolder = 'All Files';
    let folders = ['All Files'];

    async function loadFiles() {
      const res = await fetch('/api/files');
      filesCache = await res.json();
      renderFiles();
      renderFolders();
    }

    function renderFolders() {
      const list = document.getElementById('folderList');
      list.innerHTML = '';
      folders.forEach(f => {
        const div = document.createElement('div');
        div.className = 'folder' + (f === currentFolder ? ' active' : '');
        div.textContent = f;
        div.onclick = () => { currentFolder = f; renderFiles(); renderFolders(); };
        list.appendChild(div);
      });
    }

    function createFolder() {
      const name = prompt('Folder name:');
      if (!name || folders.includes(name)) return;
      folders.push(name);
      renderFolders();
    }

    function renderFiles() {
      const body = document.getElementById('fileTableBody');
      const search = document.getElementById('searchInput').value.toLowerCase();
      body.innerHTML = '';

      const filtered = filesCache.filter(f =>
        f.file_name.toLowerCase().includes(search)
      );

      if (filtered.length === 0) {
        body.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#777;">No files found.</td></tr>`;
        return;
      }

      filtered.forEach(f => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><input type="checkbox" class="file-check" data-name="${f.file_name}" /></td>
          <td>${f.file_name}</td>
          <td>${f.file_type || '—'}</td>
          <td>${new Date(f.uploaded_at).toLocaleString()}</td>
          <td><button class="delete-btn" data-name="${f.file_name}">Delete</button></td>
        `;
        body.appendChild(row);
      });
    }

    function filterFiles() { renderFiles(); }

    function toggleSelectAll(box) {
      document.querySelectorAll('.file-check').forEach(c => c.checked = box.checked);
    }

    function deleteSelected() {
      const selected = [...document.querySelectorAll('.file-check:checked')].map(c => c.dataset.name);
      if (selected.length === 0) return alert('No files selected.');
      selected.forEach(name => fetch(`/delete/${name}`, { method: 'DELETE' }));
      setTimeout(loadFiles, 500);
    }

    function uploadFile(file) {
      const progress = document.getElementById('uploadProgress');
      progress.style.display = 'block';
      progress.value = 0;

      const xhr = new XMLHttpRequest();
      xhr.open('POST', '/upload');
      xhr.upload.onprogress = e => { if (e.lengthComputable) progress.value = (e.loaded / e.total) * 100; };
      xhr.onload = () => {
        progress.value = 100;
        setTimeout(() => progress.style.display = 'none', 500);
        loadFiles();
      };
      const formData = new FormData();
      formData.append('file', file);
      xhr.send(formData);
    }

    document.addEventListener('click', e => {
      if (e.target.classList.contains('delete-btn')) {
        const name = e.target.dataset.name;
        fetch(`/delete/${name}`, { method: 'DELETE' }).then(() => loadFiles());
      }
    });

    function handleDrag(e) { e.preventDefault(); document.getElementById('dropZone').classList.add('dragover'); }
    function handleLeave(e) { e.preventDefault(); document.getElementById('dropZone').classList.remove('dragover'); }
    function handleDrop(e) {
      e.preventDefault();
      document.getElementById('dropZone').classList.remove('dragover');
      [...e.dataTransfer.files].forEach(uploadFile);
    }

    document.getElementById('fileInput').addEventListener('change', e => {
      [...e.target.files].forEach(uploadFile);
    });

    loadFiles();
  </script>
</body>
</html>
