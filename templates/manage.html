<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Manage Course Files</title>
<link rel="icon" href="/static/favicon.ico">

<style>
:root{--cardinal:#990000;--gold:#ffd700;--ink:#222;--muted:#777;--bg:#f8f8f8;--panel:#fff;--line:#e7e7e7}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--ink)}
header{background:var(--cardinal);color:#fff;padding:16px 24px;display:flex;justify-content:space-between;align-items:center}
header a{color:var(--gold);text-decoration:none}
.frame{max-width:1100px;margin:28px auto;background:var(--panel);border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,.08);padding:22px;min-height:720px;display:flex;flex-direction:column;position:relative}
h2{margin:0 0 8px;color:var(--cardinal)}
.rule{height:2px;background:var(--gold);width:100%;margin:6px 0 18px;border-radius:2px}
.drop{border:2px dashed #cfcfcf;border-radius:10px;padding:22px;text-align:center;background:#fafafa;margin-bottom:12px;transition:background .2s,border-color .2s}
.drop.drag{border-color:var(--cardinal);background:#fff6f6}
.btn{background:var(--cardinal);color:#fff;border:0;border-radius:8px;padding:9px 14px;font-size:.92rem;cursor:pointer}
.btn.secondary{background:#f3f3f3;color:#333}
.btn.danger{background:#b11226}
.btn:disabled{opacity:.5;cursor:not-allowed}
.bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:12px 0}
.bar input[type="text"]{flex:1;border:1px solid #d5d5d5;border-radius:8px;padding:9px 12px}
.progress{display:none;align-items:center;gap:10px;margin:8px 0}
.progress .track{flex:1;height:10px;background:#eee;border-radius:8px;overflow:hidden}
.progress .fill{height:100%;width:0;background:var(--cardinal);transition:width .15s linear}
table{width:100%;border-collapse:collapse;border-radius:10px;overflow:hidden}
thead{background:#f6f6f6}
th,td{padding:11px 12px;border-bottom:1px solid var(--line);font-size:.92rem}
tbody tr:hover{background:#fff6f6}
.muted{color:var(--muted)}
.row-actions{display:flex;gap:8px;justify-content:flex-end}

/* notifications */
.notice {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--cardinal);
  color: #fff;
  padding: 10px 18px;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,.2);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
  font-size: 0.9rem;
  z-index: 1000;
}
.notice.show { opacity: 1; }
</style>
</head>

<body>
<script>
const PASS = "marshall565"; // change as needed
if (!sessionStorage.getItem("authOK")) {
  const userInput = prompt("Enter access password:");
  if (userInput !== PASS) {
    window.location.href = "/";
  } else {
    sessionStorage.setItem("authOK", "true");
  }
}
</script>

{% include '_header.html' %}

<div class="frame">
  <h2>Manage Uploaded Materials</h2>
  <div class="rule"></div>

  <div id="drop" class="drop" ondrop="onDrop(event)" ondragover="onDrag(event)" ondragleave="onLeave(event)">
    <div class="muted" style="margin-bottom:6px">Drag and drop files here</div>
    <div class="muted" style="margin-bottom:10px">or</div>
    <input id="fileInput" type="file" multiple hidden />
    <button class="btn" onclick="document.getElementById('fileInput').click()">Select Files</button>
  </div>

  <div class="bar">
    <input id="search" type="text" placeholder="Search files..." oninput="renderFiles()"/>
    <button id="deleteBtn" class="btn danger" disabled>Delete Selected</button>
  </div>

  <div class="progress" id="progress">
    <span id="ptext" class="muted">Uploading…</span>
    <div class="track"><div class="fill" id="pfill"></div></div>
    <span id="pnum" class="muted">0%</span>
  </div>

  <table>
    <thead>
      <tr>
        <th style="width:36px"><input type="checkbox" id="selectAll"/></th>
        <th>Name</th>
        <th style="width:120px">Type</th>
        <th style="width:220px">Date Added</th>
        <th style="width:150px;text-align:right"></th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<div class="notice" id="notice"></div>

<script>
let files = [];
const selected = new Set();
const $ = s => document.querySelector(s);

function showNotice(msg) {
  const n = $('#notice');
  n.textContent = msg;
  n.classList.add('show');
  setTimeout(()=> n.classList.remove('show'), 2000);
}

/* ---- progress ---- */
function showProgress(name,pct){
  const bar=$('#progress');
  bar.style.display="flex";
  $('#ptext').textContent=`Uploading ${name}`;
  $('#pfill').style.width=`${pct}%`;
  $('#pnum').textContent=`${Math.round(pct)}%`;
  if(pct>=100) setTimeout(()=>{ bar.style.display="none"; $('#pfill').style.width="0%"; },600);
}

/* ---- load + render ---- */
async function loadFiles(){
  const res = await fetch("/api/files");
  files = await res.json();
  renderFiles();
}
function renderFiles(){
  const q = ($('#search').value||"").toLowerCase();
  const tbody = $('#tbody');
  tbody.innerHTML = "";
  const filtered = files.filter(f => f.file_name.toLowerCase().includes(q));

  if(filtered.length===0){
    const tr=document.createElement("tr");
    tr.innerHTML=`<td></td><td class="muted" colspan="4">No files found.</td>`;
    tbody.appendChild(tr);
  } else {
    filtered.forEach(f=>{
      const checked = selected.has(f.file_name) ? "checked" : "";
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td><input type="checkbox" class="rowcheck" data-name="${f.file_name}" ${checked}/></td>
        <td>${f.file_name}</td>
        <td>${f.file_type || "—"}</td>
        <td>${f.uploaded_at ? new Date(f.uploaded_at).toLocaleString() : "—"}</td>
        <td class="row-actions">
          <button class="btn danger" onclick="deleteFile('${f.file_name}')">Delete</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }
  $('#deleteBtn').disabled = selected.size===0;
  const allChecks = tbody.querySelectorAll('.rowcheck');
  $('#selectAll').checked = allChecks.length && [...allChecks].every(c=>c.checked);
}
window.addEventListener("DOMContentLoaded", loadFiles);

/* ---- selection ---- */
$('#tbody').addEventListener('change', e=>{
  if(e.target.classList.contains('rowcheck')){
    const name=e.target.dataset.name;
    if(e.target.checked) selected.add(name); else selected.delete(name);
    renderFiles();
  }
});
$('#selectAll').addEventListener('change', e=>{
  const checks=$('#tbody').querySelectorAll('.rowcheck');
  checks.forEach(c=>{
    c.checked=e.target.checked;
    if(e.target.checked) selected.add(c.dataset.name); else selected.delete(c.dataset.name);
  });
  renderFiles();
});

/* ---- delete ---- */
$('#deleteBtn').addEventListener('click', async ()=>{
  if(selected.size===0) return;
  for(const name of selected){
    await fetch(`/delete/${encodeURIComponent(name)}`,{method:"DELETE"});
  }
  files = files.filter(f => !selected.has(f.file_name));
  showNotice(`${selected.size} file(s) deleted`);
  selected.clear();
  renderFiles();
});

async function deleteFile(name){
  await fetch(`/delete/${encodeURIComponent(name)}`,{method:"DELETE"});
  files = files.filter(f=>f.file_name!==name);
  renderFiles();
  showNotice(`${name} deleted`);
}

/* ---- drag & drop ---- */
function onDrag(e){ e.preventDefault(); $('#drop').classList.add('drag'); }
function onLeave(e){ e.preventDefault(); $('#drop').classList.remove('drag'); }

/* ---- upload handling ---- */
async function uploadFilesSequentially(fileList){
  for(const file of fileList){
    await uploadFile(file);
  }
}

$('#fileInput').addEventListener('change', async e=>{
  const list = [...e.target.files];
  e.target.value="";
  if(!list.length) return;
  await uploadFilesSequentially(list);
});

function onDrop(e){
  e.preventDefault();
  onLeave(e);
  const list = [...e.dataTransfer.files];
  if(!list.length) return;
  uploadFilesSequentially(list);
}

function uploadFile(file){
  return new Promise(resolve=>{
    const xhr = new XMLHttpRequest();
    xhr.open("POST","/upload");
    xhr.upload.onprogress = e=>{
      if(e.lengthComputable) showProgress(file.name,(e.loaded/e.total)*100);
    };
    xhr.onload = async ()=>{
      if(xhr.status===200){
        // Wait briefly to let backend finish writing, then reload list
        setTimeout(async ()=>{
          const res = await fetch("/api/files");
          files = await res.json();
          renderFiles();
          showNotice(`${file.name} uploaded`);
        },200);
      } else {
        showNotice(`Upload failed: ${file.name}`);
      }
      resolve();
    };
    const form = new FormData();
    form.append("file", file);
    xhr.send(form);
  });
}
</script>
</body>
</html>
